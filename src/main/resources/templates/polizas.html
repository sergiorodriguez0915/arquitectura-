<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"> // usamos Thymeleaf para plantillas
<head>

    <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/estilos.css}">

    <style>
        /* Resaltar fila seleccionada */
        .fila-seleccionada {
            background-color: #cfe2ff !important;
        }
    </style>
</head>

<div th:replace="fragments/layout :: layout(~{this :: content})"> // Usar el layout principal

    <div th:fragment="content" class="container mt-4">

        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <h3 class="mb-4">Gestión de Pólizas</h3>

                <!-- BARRA SUPERIOR DE ACCIONES -->
                <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">

                    <form th:action="@{/web/polizas}" method="get" class="d-flex gap-2 flex-wrap">
                        <select id="selectFiltro" name="filtro" class="form-select">
                            <option value="clave" th:selected="${filtro == 'clave'}">Clave</option>
                            <option value="curp" th:selected="${filtro == 'curp'}">CURP</option>
                            <option value="nombre" th:selected="${filtro == 'nombre'}">Nombre completo</option>
                            <option value="tipo" th:selected="${filtro == 'tipo'}">Tipo</option>
                        </select>

                        <input type="text" name="valor" class="form-control" placeholder="Valor a buscar" th:value="${valor}">

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>

                    <!-- EDITAR -->
                    <button type="button" id="btnEditarGeneral" class="btn btn-warning" disabled onclick="editarGeneral()">
                        <i class="fas fa-edit"></i> Editar Seleccionado
                    </button>

                    <!-- ELIMINAR -->
                    <button type="button" id="btnEliminarGeneral" class="btn btn-danger" disabled onclick="eliminarGeneral()">
                        <i class="fas fa-trash"></i> Eliminar Seleccionado
                    </button>

                    <!-- NUEVA POLIZA -->
                    <button type="button" class="btn btn-primary ms-auto" onclick="abrirModalCrear()">
                        <i class="fas fa-plus-circle"></i> Nueva Póliza
                    </button>

                </div>

                <!-- TABLA SIN COLUMNA ACCIONES -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="tablaPolizas">
                        <thead class="table-light">
                        <tr>
                            <th>Clave</th>
                            <th>Tipo</th>
                            <th>Monto</th>
                            <th>Descripción</th>
                            <th>Cliente</th>
                            <th>CURP</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="p : ${polizas}"
                            th:data-clave="${p.clave}"
                            th:data-tipo="${p.tipo}"
                            th:data-monto="${p.monto}"
                            th:data-descripcion="${p.descripcion}"
                            th:data-curp="${p.cliente != null ? p.cliente.curp : ''}">
                            <td th:text="${p.clave}"></td>
                            <td th:text="${p.tipo}"></td>
                            <td th:text="${p.monto}"></td>
                            <td th:text="${p.descripcion}"></td>
                            <td th:text="${p.cliente != null ? p.cliente.nombres + ' ' + p.cliente.primerApellido : 'Sin cliente'}"></td>
                            <td th:text="${p.cliente != null ? p.cliente.curp : 'N/A'}"></td>
                        </tr>
                        </tbody>

                    </table>
                </div>

            </div>
        </div>


        <!-- MODAL DE POLIZA -->
        <div class="modal fade" id="modalPoliza" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content shadow">

                    <div class="modal-header bg-primary text-white">
                        <h5 id="tituloModal" class="modal-title">Nueva Póliza</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <form id="formPoliza" method="post">
                        <div class="modal-body">

                            <div class="row g-3">

                                <div class="col-md-4">
                                    <label class="form-label">Clave</label>
                                    <input id="clave" name="clave" class="form-control" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Tipo</label>
                                    <input id="tipo" name="tipo" class="form-control" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Monto</label>
                                    <input id="monto" name="monto" type="number" class="form-control" required>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Descripción</label>
                                    <textarea id="descripcion" name="descripcion" class="form-control" rows="3"></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">CURP del Cliente</label>
                                    <select id="cliente" name="cliente.curp" class="form-select" required>
                                        <option value="">Seleccione...</option>

                                        <option th:each="c : ${clientes}"
                                                th:value="${c.curp}"
                                                th:text="${c.curp + ' - ' + c.nombres + ' ' + c.primerApellido}">
                                        </option>
                                    </select>
                                </div>

                            </div>

                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancelar
                            </button>

                            <button id="btnGuardar" type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>


<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js}"></script> // Bootstrap JS

<script>

    let filaSeleccionada = null;  // variable para almacenar la fila seleccionada
    const modal = new bootstrap.Modal(document.getElementById('modalPoliza'));  // inicializar modal

       // seleccionar fila de la tabla
    document.querySelectorAll("#tablaPolizas tbody tr").forEach(row => {

        row.addEventListener("click", () => {

            if (filaSeleccionada)
                filaSeleccionada.classList.remove("fila-seleccionada");

            filaSeleccionada = row;
            row.classList.add("fila-seleccionada");

            validarBotones();
        });
    });

       // validar botones mediante condicional para editar y eliminar
    function validarBotones() {
        const filtro = document.getElementById("selectFiltro").value;

        const btnEditar = document.getElementById("btnEditarGeneral");
        const btnEliminar = document.getElementById("btnEliminarGeneral");

        if (!filaSeleccionada) {
            btnEditar.disabled = true;
            btnEliminar.disabled = true;
            return;
        }

        // Editar solo con clave o curp
        btnEditar.disabled = !(filtro === "clave" || filtro === "curp");

        // Eliminar solo con clave
        btnEliminar.disabled = !(filtro === "clave");
    }

    document.getElementById("selectFiltro").addEventListener("change", validarBotones);


       //crear nueva poliza
    function abrirModalCrear() {
        document.getElementById('tituloModal').innerText = "Nueva Póliza";
        document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-save"></i> Crear';

        document.getElementById('clave').value = ""; // obtener los datos del formulario
        document.getElementById('tipo').value = "";
        document.getElementById('monto').value = "";
        document.getElementById('descripcion').value = "";
        document.getElementById('cliente').value = "";

        document.getElementById('formPoliza').action = "/web/polizas/crear"; // configurar la acción del formulario

        modal.show();
    }

       //editar solo por clave o curp
    function editarGeneral() {
        const filtro = document.getElementById("selectFiltro").value;

        if (filtro !== "clave" && filtro !== "curp") {
            alert("Solo puedes editar si filtraste por CLAVE o CURP.");
            return;
        }

        editarPoliza(filaSeleccionada);
    }

       //rellenar modal con datos de la poliza
    function editarPoliza(row) {

        const clave = row.dataset.clave;
        const tipo = row.dataset.tipo;
        const monto = row.dataset.monto;
        const descripcion = row.dataset.descripcion;
        const curp = row.dataset.curp;

        document.getElementById('tituloModal').innerText = "Editar Póliza";
        document.getElementById('btnGuardar').innerHTML = '<i class="fas fa-edit"></i> Actualizar';

        document.getElementById('clave').value = clave;
        document.getElementById('tipo').value = tipo;
        document.getElementById('monto').value = monto;
        document.getElementById('descripcion').value = descripcion;
        document.getElementById('cliente').value = curp;

        document.getElementById('formPoliza').action = "/web/polizas/actualizar"; // POST a /web/polizas/actualizar

        modal.show();
    }

      // eliminar solo por clave
    function eliminarGeneral() {
        const filtro = document.getElementById("selectFiltro").value;

        if (filtro !== "clave") {
            alert("Solo puedes eliminar si filtraste por CLAVE.");
            return;
        }

        if (!filaSeleccionada) {
            alert("Selecciona una póliza primero.");
            return;
        }

        const clave = filaSeleccionada.dataset.clave;

        if (!confirm("¿Seguro que deseas eliminar la póliza con clave " + clave + "?"))
            return;

        // Crear formulario y enviarlo
        const form = document.createElement("form");
        form.method = "post";
        form.action = "/web/polizas/borrar";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "clave";
        input.value = clave;

        form.appendChild(input);
        document.body.appendChild(form);

        form.submit();
    }

</script>

</html>